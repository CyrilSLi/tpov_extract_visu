<!DOCTYPE html>
<html lang="en">
<head>
    <title>tpov_extract Stop Data Visualization</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ace-builds@1/css/ace.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1/dist/leaflet.polylineDecorator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.37.5/src/ace.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/split.js@1/dist/split.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2/dist/proj4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4leaflet@1/src/proj4leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gcoord@1/dist/gcoord.global.min.js"></script>
    <style>
        html, body, div {
            margin: 0px;
        }
        html, body {
            margin: 0px;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        h1 {
            font-family: Arial, sans-serif;
            color: #000000;
            font-size: 28px;
            font-weight: bold;
            margin: 10px;
        }
        #map {
            height: 100%;
            width: 100%;
            position: relative;
        }
        #editor {
            height: 100%;
            width: 100%;
            position: relative;
            font-size: 16px;
        }
        #app {
            flex: 1;
            display: flex;
        }
        .gutter {
            cursor: ew-resize;
        }
    </style>
</head>
<body>
    <noscript><p>JavaScript is required to use this website.</p></noscript>
    <h1 id="title">tpov_extract Stop Data Visualization</h1>
    <div id="app">
        <div id="map"></div>
        <div id="editor"></div>
    </div>
    <script>
        window.Split(["#map", "#editor"], {
            sizes: [60, 40],
            minSize: [0, 0],
            snapOffset: 100,
            gutterSize: 10,
            gutterAlign: "center",
            direction: "horizontal",
        });

        var stopData = '%stopData%'; // single quotes to avoid escaping
        if (stopData === "%stop" + "Data%") {
            alert("Do not open this page directly. Please use the CLI tool.")
            throw new Error("Do not open this page directly. Please use the CLI tool.");
        } else {
            stopData = JSON.parse(new TextDecoder().decode(new Uint8Array(stopData.split(","))));
        }
    
        document.title = `${stopData.agency_name} ${stopData.route_long_name} | tpov_extract Visualization`;
        document.getElementById("title").textContent = `${stopData.agency_name} ${stopData.route_long_name} | tpov_extract Visualization`;

        const textData = JSON.stringify(stopData, null, 4).split("\n"); // for line numbers
        const editor = ace.edit("editor");
        editor.session.setMode("ace/mode/json");
        editor.setReadOnly(true);
        function foldObject (startLine) {
            const startIndent = textData[startLine].search(/\S/);
            const endLine = startLine + 1 + textData.slice(startLine + 1).map(i => i.search(/\S/) === startIndent).indexOf(true);
            setTimeout(() => editor.session.foldAll(startLine, endLine, 0), 0);
        }
        function foldStartsWith (text) {
            foldObject(textData.map(i => i.trim().startsWith(text)).indexOf(true));
        }
        function showGlobal() {
            editor.setValue(textData.join("\n"), -1);
            foldStartsWith('"__stops__": [');
            if (stopData.__shape__) {
                foldStartsWith('"__shape__": [');
            }
        }
        showGlobal();

        
        var stopLine = L.polyline([]);
        function showStops(e) {
            editor.setValue(JSON.stringify(stopData.__stops__, null, 4), -1);
        }
        stopLine.on("click", showStops);

        var shapeLine = L.polyline([]);
        function showShape(e) {
            editor.setValue(JSON.stringify(stopData.__shape__, null, 4), -1);
        }
        shapeLine.on("click", showShape);

        const osmLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href = 'https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors",
            maxZoom: 19,
        });

        const EPSG3395 = "+proj=longlat +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +type=crs";
        const EPSG4326 = "+proj=longlat +datum=WGS84 +no_defs +type=crs";

        const baiduCRS = new L.Proj.CRS(
            "EPSG:3395",
            "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs", {
                resolutions: [262144, 131072, 65536, 32768, 16384, 8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1],
                origin: [0, 0],
                bounds: L.bounds([20037508.342789244, 0], [0, 20037508.342789244])
            }
        );
        const baiduLayer =  L.tileLayer(
            "https://maponline{s}.bdimg.com/tile/?qt=vtile&x={x}&y={y}&z={z}&styles=pl", {
                subdomains: ["0", "1", "2", "3"],
                maxZoom: 19,
                tms: true
            }
        );

        const layerControl = L.control.layers(
            {
                "OpenStreetMap": osmLayer,
                "Baidu": baiduLayer,
            }, {
                "Stop Line": stopLine,
                "Shape Line": shapeLine
            }
        )

        var map;
        function parseCoord(layer, coord) {
            if (layer === baiduLayer) {
                return gcoord.transform([parseFloat(coord[1]), parseFloat(coord[0])], gcoord.WGS84, gcoord.BD09);
            } else {
                return [parseFloat(coord[1]), parseFloat(coord[0])];
            }
        }
        function createMap(layer) {
            console.log(map);
            if (map) {
                map.remove();
            }

            stopLine = L.polyline(stopData.__stops__.map(stop => parseCoord(layer, [stop.stop_lon, stop.stop_lat])), {
                color: "blue",
                weight: 7,
                opacity: 0.8,
                smoothFactor: 0,
                bubblingMouseEvents: false,
            });
            shapeLine = L.polyline((stopData.__shape__ || []).map(shape => parseCoord(layer, shape)), {
                color: "red",
                weight: 7,
                opacity: 0.8,
                smoothFactor: 0,
                bubblingMouseEvents: false,
            });

            map = L.map("map", {
                layers: [layer, stopData.__shape__ ? shapeLine : stopLine],
                crs: layer === baiduLayer ? baiduCRS : L.CRS.EPSG3857,
            });
            layerControl.addTo(map);
            setTimeout(() => map.fitBounds(stopLine.getBounds()), 0);
            setTimeout(() => map.on("baselayerchange", function (e) {
                createMap(e.layer);
            }), 0);

            L.easyButton('<i class="bi bi-globe"></i>', function (btn, map) {
                showGlobal();
            }, "Show global data").addTo(map);
            L.easyButton('<i class="bi bi bi-geo-alt-fill"></i>', function (btn, map) {
                showStops();
            }, "Show stop list").addTo(map);
            L.easyButton('<i class="bi bi-bezier2"></i>', function (btn, map) {
                showShape();
            }, "Show shape list").addTo(map);

            stopData.__stops__.map(stop => {
                L.marker(parseCoord(layer, [stop.stop_lon, stop.stop_lat]))
                .bindTooltip(stop.stop_name)
                .addTo(map)
                .on("click", function (e) {
                    editor.setValue(JSON.stringify(stop, null, 4), -1);
                });
            });
        }
        createMap(baiduLayer);

        

        

        function resizePanes() {
            map.invalidateSize();
            editor.resize();
        }
        const gutter = document.getElementsByClassName("gutter")[0];
        var _mouseDown = false;
        gutter.addEventListener("mousedown", function () {
            _mouseDown = true;
        });
        document.addEventListener("mouseup", function () {
            _mouseDown = false;
            resizePanes();
        });
        gutter.addEventListener("mousemove", function () {
            if (_mouseDown) {
                resizePanes();
            }
        });
    </script>
</body>
</html>
